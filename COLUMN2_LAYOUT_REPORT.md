# 중단 세션 2열 기능 배치 현황 보고서

📅 **보고 날짜**: 2025-11-12  
🎯 **대상**: YONA Vanguard Futures (new) - 중단 세션 2열 (우측 37%)

---

## 📊 전체 레이아웃 구조

```
┌─────────────────────────────────────────────────────────────────┐
│  헤더 위젯 (상단 10%)                                            │
│  - 계좌 정보, 잔고, START/STOP 버튼                              │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│  중단 세션 (중앙 50%)                                            │
│  ┌──────────────────────────┬───────────────────────────────┐   │
│  │  1열 (63%)               │  2열 (37%)                    │   │
│  │  - 실시간 랭킹리스트      │  🎯 포지션 진입 분석          │   │
│  │  - Settling/Blacklist    │     (Coin Momentum & Chart)  │   │
│  └──────────────────────────┴───────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│  푸터 위젯 (하단 40%)                                            │
│  - 알파/베타/감마 자동매매 엔진 (3개)                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🎯 2열 상세 구성 (우측 37%)

### **헤더 섹션**
```
┌─────────────────────────────────────────────────────────┐
│  Coin Momentum & Chart          [ 타이밍 분석 ] 버튼   │
└─────────────────────────────────────────────────────────┘
```

**구성 요소**:
- **제목 라벨**: `self.entry_title`
  - 기본값: "Coin Momentum & Chart"
  - 심볼 선택 시: "포지션 진입 - {SYMBOL}"
  - 스타일: `font-weight: bold; font-size: 12px;`

- **[ 타이밍 분석 ] 버튼**: `self.analyze_button`
  - 기능: 자동 분석 ON/OFF 토글
  - 상태 1: "[ 타이밍 분석 ]" (분석 중지)
  - 상태 2: "[ 자동 분석 중 ]" (2초마다 자동 분석)
  - 스타일: 파란색 배경 (`#1e88e5`)

---

### **위젯 1: 추세 분석 (TrendAnalysisWidget)**
```
┌─────────────────────────────────────────────────────────┐
│  5분봉: 상승 (지지선 근접) - 상승 에너지: +5.2% ┌████▆▃▁▁┐ 65%   │
│  15분봉: 상승 (저항선 돌파) - 상승 에너지: +8.1% ┌████████┐ 90%  │
│  종합: 거래 고려 🔸 (예상 상승: +5-12%)                    │
└─────────────────────────────────────────────────────────┘
```

**파일**: `gui/widgets/position_analysis_widgets.py` (Line 7-147)  
**클래스**: `TrendAnalysisWidget`  
**높이**: 고정 120px

**표시 정보**:
1. **5분봉 추세**
   - 방향: 강상승/상승/횡보/하락/강하락
   - 가격 상태: 지지선 근접/저항선 돌파/횡보 중
   - 상승 에너지: 예상 상승률(%) 표시
   - 강도 게이지: 블록 바 형태 (0-100%)

2. **15분봉 추세**
   - 5분봉과 동일한 형식
   - 장기 추세 확인용

3. **종합 판단**
   - 색상 코드:
     - `#28a745` (초록): 거래 권장 ✅
     - `#20c997` (청록): 거래 고려 🔸
     - `#ffc107` (노랑): 횡보 중 ⚖️
     - `#dc3545` (빨강): 거래 금지 ❌
     - `#6f42c1` (보라): 거래 금지 ❌ (강하락)

**데이터 소스**:
- API: `GET /api/v1/live/analysis/entry?symbol={SYMBOL}`
- 응답 필드: `trend_analysis.5m`, `trend_analysis.15m`, `trend_analysis.overall`

---

### **위젯 2: 타이밍 분석 차트 (TimingAnalysisView)**
```
┌─────────────────────────────────────────────────────────┐
│  BTCUSDT                                                │
│                                                         │
│   105,000 ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈ TP2 (익절 2)                 │
│   104,500 ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈ TP1 (익절 1)                 │
│   104,200 ████████████████ 가격선 (Close)               │
│   104,000 ━━━━━━━━━━━━━━━━ EMA20 (파랑)                │
│   103,800 ━━━━━━━━━━━━━━━━ EMA50 (빨강)                │
│   103,500 ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈ Stop Loss (손절)            │
│   103,200 ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ 진입 존 (Entry Zone)        │
│                                                         │
│   ◀──────────── 시간 (최근 50분) ────────────▶          │
└─────────────────────────────────────────────────────────┘
```

**파일**: `gui/widgets/position_analysis_widgets.py` (Line 238-367)  
**클래스**: `TimingAnalysisView`  
**최소 높이**: 240px (가변)

**표시 요소**:
1. **가격선 (Close)**
   - 색상: `#333333` (검정)
   - 굵기: 2px
   - 데이터: 최근 50개 캔들의 종가

2. **EMA20 (지수이동평균 20)**
   - 색상: `#2196F3` (파랑)
   - 굵기: 1px
   - 의미: 단기 추세선

3. **EMA50 (지수이동평균 50)**
   - 색상: `#e16476` (빨강)
   - 굵기: 1px
   - 의미: 중기 추세선

4. **VWAP (거래량 가중 평균 가격)**
   - 색상: `#9C27B0` (보라)
   - 굵기: 1px
   - 의미: 기관 매매 기준선

5. **Entry Zone (진입 존)**
   - 색상: 초록색 반투명 (`rgba(0, 255, 0, 0.3)`)
   - 의미: 권장 진입 가격 범위

6. **Stop Loss (손절선)**
   - 색상: `#e16476` (빨강)
   - 굵기: 2px
   - 스타일: 점선

7. **Take Profit 1/2 (익절선)**
   - 색상: `#03b662` (초록)
   - 굵기: 1px
   - 스타일: 점선

**데이터 소스**:
- API: `GET /api/v1/live/analysis/entry?symbol={SYMBOL}`
- 응답 필드:
  - `series.close`: 종가 배열
  - `series.ema20`: EMA20 배열
  - `series.ema50`: EMA50 배열
  - `series.vwap`: VWAP 배열
  - `levels.entry_zone`: 진입 존 (low, high)
  - `levels.stop`: 손절가
  - `levels.tp1`: 익절가 1
  - `levels.tp2`: 익절가 2

---

## ⚙️ 동작 흐름

### **1. 심볼 선택 (실시간 랭킹리스트 클릭)**

```
사용자 클릭 (상승률%/누적/상승유형 컬럼)
    ↓
RankingTableWidget._on_cell_clicked(row, col)
    ↓
analyze_requested Signal 발생
    ↓
YONAMainWindow._on_analyze_symbol(symbol)
    ↓
self.selected_symbol = symbol
self.entry_title.setText(f"포지션 진입 - {symbol}")
    ↓
_start_analysis() 호출
```

### **2. 분석 데이터 수집**

```
_start_analysis()
    ↓
analysis_timer.start() (2초마다 자동 갱신)
    ↓
_on_analyze_timing() (Worker 스레드)
    ↓
GET /api/v1/live/analysis/entry?symbol={SYMBOL}
    ↓
바이낸스 API:
  - 1분봉 100개 수집
  - EMA20, EMA50 계산
  - 추세 판단 (상승/하락/횡보)
    ↓
analysis_ready Signal 발생 (데이터 포함)
```

### **3. UI 업데이트 (메인 스레드)**

```
analysis_ready Signal 수신
    ↓
_apply_analysis_data(data) @Slot
    ↓
┌────────────────────────────────────┐
│  trend_analysis.update_trend()     │ ← 추세 분석 위젯 업데이트
│  analysis_view.set_data()          │ ← 차트 위젯 업데이트
└────────────────────────────────────┘
    ↓
UI 스레드에서 paintEvent() 호출
    ↓
차트 렌더링 완료
```

---

## 📡 API 연동 상세

### **엔드포인트**
```
GET http://127.0.0.1:8200/api/v1/live/analysis/entry
```

### **요청 파라미터**
```json
{
  "symbol": "BTCUSDT"
}
```

### **응답 데이터 구조**
```json
{
  "status": "ok",
  "data": {
    "symbol": "BTCUSDT",
    "score": 50,
    "series": {
      "close": [104463.8, 104449.0, ...],
      "ema20": [104374.27, 104381.39, ...],
      "ema50": [104394.07, 104396.23, ...],
      "vwap": [],
      "bpr": [],
      "vss": []
    },
    "trend_analysis": {
      "5m": {
        "direction": "상승",
        "strength": 65,
        "predicted_upside": 5.2,
        "price_status": {
          "status": "지지선 근접"
        }
      },
      "15m": {
        "direction": "상승",
        "strength": 90,
        "predicted_upside": 8.1,
        "price_status": {
          "status": "저항선 돌파"
        }
      },
      "overall": "거래 고려 🔸 (예상 상승: +5-12%)"
    },
    "levels": {
      "entry_zone": {
        "low": 103200,
        "high": 103500
      },
      "stop": 103500,
      "tp1": 104500,
      "tp2": 105000
    }
  }
}
```

---

## 🎨 스타일 및 색상 체계

### **추세 분석 위젯**
- 배경: `#f8f9fa` (연회색)
- 테두리: `#e9ecef` (회색)
- 둥근 모서리: 8px

### **차트 색상**
| 요소 | 색상 코드 | 의미 |
|------|-----------|------|
| 가격선 | `#333333` | 검정 (메인) |
| EMA20 | `#2196F3` | 파랑 (단기 추세) |
| EMA50 | `#e16476` | 빨강 (중기 추세) |
| VWAP | `#9C27B0` | 보라 (기관선) |
| 진입존 | `rgba(0,255,0,0.3)` | 초록 반투명 |
| 손절선 | `#e16476` | 빨강 |
| 익절선 | `#03b662` | 초록 |

### **종합 판단 색상**
| 판단 | 색상 | 의미 |
|------|------|------|
| 강상승 | `#28a745` | 거래 권장 ✅ |
| 상승 | `#20c997` | 거래 고려 🔸 |
| 횡보 | `#ffc107` | 횡보 중 ⚖️ |
| 하락 | `#dc3545` | 거래 금지 ❌ |
| 강하락 | `#6f42c1` | 거래 금지 ❌ |

---

## 🔧 주요 파일 위치

### **GUI 코드**
1. **main.py** (Line 173-199)
   - 2열 레이아웃 구성
   - Signal/Slot 연결
   - 타이머 관리

2. **position_analysis_widgets.py**
   - `TrendAnalysisWidget` (Line 7-147): 추세 분석
   - `GaugeWidget` (Line 150-235): 게이지 (현재 미사용)
   - `TimingAnalysisView` (Line 238-367): 차트

### **백엔드 코드**
1. **yona_service.py** (Line 665-780)
   - `analyze_entry_timing()`: 분석 로직
   - `_get_fallback_analysis()`: 오류 시 기본 데이터

2. **routes.py** (Line 77-97)
   - API 엔드포인트 정의

3. **binance_client.py** (Line 99-116)
   - `get_klines()`: 캔들 데이터 수집

---

## ✅ 현재 작동 상태

### **정상 작동 기능**
- ✅ 실시간 랭킹리스트 클릭 감지
- ✅ 심볼 선택 시 제목 업데이트
- ✅ 바이낸스 API 데이터 수집 (1분봉 100개)
- ✅ EMA20, EMA50 계산
- ✅ 추세 판단 (상승/하락/횡보)
- ✅ Signal/Slot 패턴으로 UI 스레드 안전성 보장
- ✅ 2초마다 자동 갱신 (타이머)
- ✅ 추세 분석 위젯 업데이트
- ✅ 차트 렌더링 (가격선 + EMA20 + EMA50)

### **구현 대기 기능**
- ⏳ VWAP, BPR, VSS 지표 (데이터 수집 필요)
- ⏳ 진입존, 손절/익절 레벨 계산 (로직 추가 필요)
- ⏳ 게이지 위젯 표시 (현재 미연결)

---

## 📝 요약

**2열 구성**: 포지션 진입 분석 섹션 (우측 37%)

**위젯 수**: 3개
1. 헤더 (제목 + 버튼)
2. 추세 분석 (120px 고정)
3. 차트 (가변 높이, 최소 240px)

**데이터 흐름**:
```
사용자 클릭 → Signal → API 호출 → Signal → UI 업데이트
```

**갱신 주기**: 2초 (자동 분석 활성화 시)

**데이터 소스**: 바이낸스 선물 API (1분봉)

**스레드 안전**: Signal/Slot 패턴으로 보장됨

---

📌 **보고서 작성 완료** - 2025-11-12
