**********************
Windows PowerShell transcript start
Start time: 20251217054945
Username: DESKTOP-QU3OTU8\User
RunAs User: DESKTOP-QU3OTU8\User
Configuration Name: 
Machine: DESKTOP-QU3OTU8 (Microsoft Windows NT 10.0.19045.0)
Host Application: C:\WINDOWS\System32\WindowsPowerShell\v1.0\powershell.exe -noexit -command try { . "c:\Users\User\AppData\Local\Programs\Microsoft VS Code\resources\app\out\vs\workbench\contrib\terminal\common\scripts\shellIntegration.ps1" } catch {}
Process ID: 17004
PSVersion: 5.1.19041.6456
PSEdition: Desktop
PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1.19041.6456
BuildVersion: 10.0.19041.6456
CLRVersion: 4.0.30319.42000
WSManStackVersion: 3.0
PSRemotingProtocolVersion: 2.3
SerializationVersion: 1.1.0.1
**********************
Transcript started, output file is C:\Users\User\new\backtest_run_output.txt
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
]633;D]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>Write-Output "==USING PYTHON=="
==USING PYTHON==
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>$pyPath = 'C:\Users\User\new\yona_vanguard_futures\.venv_backtest\Scripts\python.exe'
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>Write-Output $pyPath
C:\Users\User\new\yona_vanguard_futures\.venv_backtest\Scripts\python.exe
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
]633;D]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>if (-not (Test-Path $pyPath)) { Write-Output "Python not found at $pyPath; aborting"; Stop-Transcript; exit 1 }
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
]633;D]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS># Stop any processes using that python
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>$procs = Get-Process -ErrorAction SilentlyContinue | Where-Object { $_.Path -eq $pyPath }
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>if ($procs) { Write-Output "Stopping python processes:"; $procs | ForEach-Object { Write-Output ("Stopping pid={0}" -f $_.Id); Stop-Process -Id $_.Id -Force } } else { Write-Output "No running python processes for that venv" }
No running python processes for that venv
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
]633;D]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS># Stop processes listening on port 8001
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>try { $owners = Get-NetTCPConnection -LocalPort 8001 -ErrorAction SilentlyContinue | Select-Object -ExpandProperty OwningProcess -Unique } catch { $owners = $null }
]633;D;1]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>if ($owners) { $owners | ForEach-Object { Write-Output ("Stopping owner pid={0}" -f $_); Stop-Process -Id $_ -Force -ErrorAction SilentlyContinue } } else { Write-Output "No owners on port 8001" }
No owners on port 8001
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
]633;D]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>Write-Output "==STARTING uvicorn=="
==STARTING uvicorn==
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>Start-Process -FilePath $pyPath -ArgumentList '-m','uvicorn','backtesting_backend.app_main:app','--port','8001' -WorkingDirectory (Get-Location)
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>Start-Sleep -Seconds 4
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
]633;D]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>try { $cn = Test-NetConnection -ComputerName 127.0.0.1 -Port 8001 -WarningAction SilentlyContinue; Write-Output ("Port check: TcpTestSucceeded={0}" -f $cn.TcpTestSucceeded) } catch { Write-Output "Port check failed: $_" }
Port check: TcpTestSucceeded=False
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
]633;D]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS># POST + poll
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>Write-Output "==POST+POLL backtest=="
==POST+POLL backtest==
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>$now = [int](Get-Date -UFormat %s) * 1000
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>$start = $now - 3600000
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>$bodyObj = @{
  strategy_name = 'alpha'; symbol = 'BTCUSDT'; interval = '1m'; start_time = $start; end_time = $now; initial_balance = 1000.0; leverage = 1; parameters = @{}
}
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>$body = $bodyObj | ConvertTo-Json -Depth 10
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>$body | Out-File -Encoding utf8 tmp_backtest_req.json
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>Write-Output '==REQUEST BODY=='
==REQUEST BODY==
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>Get-Content tmp_backtest_req.json | Write-Output
{
    "start_time":  1765946995000,
    "end_time":  1765950595000,
    "leverage":  1,
    "symbol":  "BTCUSDT",
    "strategy_name":  "alpha",
    "initial_balance":  1000,
    "parameters":  {

                   },
    "interval":  "1m"
}
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
]633;D]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>try {
  $resp = Invoke-RestMethod -Uri 'http://127.0.0.1:8001/api/v1/backtest/run_backtest' -Method Post -Body $body -ContentType 'application/json' -TimeoutSec 120
  Write-Output '==RESPONSE=='
  $resp | ConvertTo-Json -Depth 10 | Write-Output
} catch {
  Write-Output 'REQUEST ERROR:'
  Write-Output $_.Exception.Message
}
>> TerminatingError(Invoke-RestMethod): "Unable to connect to the remote server"
REQUEST ERROR:
Unable to connect to the remote server
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
]633;D]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>$run_id = $null
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>if ($resp -and $resp.run_id) { $run_id = $resp.run_id }
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>Write-Output ("==run_id== {0}" -f $run_id)
==run_id==
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
]633;D]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>if ($run_id) {
  for ($i=0; $i -lt 120; $i++) {
    Start-Sleep -Seconds 5
    try {
      $s = Invoke-RestMethod -Uri ("http://127.0.0.1:8001/api/v1/backtest/backtest_status/{0}" -f $run_id) -Method Get -TimeoutSec 10
      Write-Output ("POLL {0}:" -f $i)
      ConvertTo-Json $s -Depth 10 | Write-Output
      if ($s.status -ne 'running') { break }
    } catch {
      Write-Output ("POLL_ERROR {0}: {1}" -f $i, $_.Exception.Message)
    }
  }
  try {
    $res = Invoke-RestMethod -Uri ("http://127.0.0.1:8001/api/v1/backtest/backtest_result/{0}" -f $run_id) -Method Get -TimeoutSec 10
    Write-Output '==RESULT=='
    ConvertTo-Json $res -Depth 10 | Write-Output
  } catch {
    Write-Output 'RESULT_FETCH_ERROR:'
    Write-Output $_.Exception.Message
  }

  # DB check
  Write-Output '==DB ROW CHECK=='
  $pyCheck = @'
import sqlite3,sys
run_id=sys.argv[1]
db=r"c:\Users\User\new\yona_backtest.db"
conn=sqlite3.connect(db)
c=conn.cursor()
try:
    c.execute('SELECT run_id, initial_balance, final_balance FROM backtest_results WHERE run_id=?', (run_id,))
    r=c.fetchone()
    print('DB_ROW:', r)
except Exception as e:
    print('DB_ERROR:', e)
finally:
    conn.close()
'@
  $tmp = Join-Path $env:TEMP ("check_db_{0}.py" -f ([guid]::NewGuid().ToString()))
  $pyCheck | Out-File -Encoding utf8 -FilePath $tmp
  Write-Output ("Running python DB check: {0} {1}" -f $tmp, $run_id)
  try { & $pyPath $tmp $run_id | Write-Output } catch { Write-Output "Python DB check failed: $_" }
  Remove-Item $tmp -ErrorAction SilentlyContinue
} else {
  Write-Output 'No run_id returned; aborting'
}
No run_id returned; aborting
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>Write-Output '==TAIL backtest log if exists=='
==TAIL backtest log if exists==
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>$possible = @('logs\backtest_app.log', '.\logs\backtest_app.log', 'backtesting_backend\logs\backtest_app.log')
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>foreach ($p in $possible) { if (Test-Path $p) { Write-Output ("Found log: {0}" -f $p); Get-Content $p -Tail 80 | Write-Output; break } }
]633;D;0]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
]633;D]633;A]633;P;Cwd=C:\x5cUsers\x5cUser\x5cnewPS C:\Users\User\new> ]633;B
PS>Stop-Transcript
**********************
Windows PowerShell transcript end
End time: 20251217054956
**********************
