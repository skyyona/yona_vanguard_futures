# 백테스팅과 실거래 전략 불일치 분석 보고서

**분석일**: 2025-11-20  
**분석 대상**: TNSRUSDT (+451.18% 상승, 상승에너지 100%) 백테스트 "부적합" 판정

---

## 🚨 핵심 문제 제기

### 사용자 지적 사항

```
상승률: +451.18%
상승에너지 (분봉): 100%
백테스트 결과: ❌ 부적합 (0점)

→ 이런 식이면 실제 거래 시 진입하지 않을 수 있다!
```

---

## 🔍 원인 분석

### 1️⃣ **백테스팅과 실거래는 다른 평가 기준을 사용**

#### 실시간 랭킹리스트 (실거래)

**평가 기준**: **24시간 상승률** (단순 가격 변동)
```python
# backend/core/yona_service.py
change_percent = ((ticker_price - open_24h) / open_24h) * 100

# +451.18% = 24시간 동안 4.5배 상승
```

**결과**: 
- ✅ TNSRUSDT가 1위로 표시됨
- ✅ 상승률만 보고 순위 결정

---

#### 백테스팅 (적합성 평가)

**평가 기준**: **우리 앱 전략의 실제 수익성** (7일 또는 30일)
```python
# backend/api/routes.py - evaluate_suitability()

평가 항목:
1. 승률 (30점)        - 백테스트 거래 중 이긴 거래 비율
2. 수익률 (40점)      - 백테스트 최종 수익률 (+2% 이상 필요)
3. MDD (20점)         - 최대 낙폭 (3% 이하 필요)
4. 거래 횟수 (10점)   - 거래 기회 (5회 이상 필요)

적합 판정 조건:
- 70점 이상 + 승률 >= 50% + 수익률 >= +2%
```

**결과**:
- ❌ TNSRUSDT의 7일 백테스트에서 우리 전략으로 수익 못 냄
- ❌ 0점 = 거래 기회 없거나, 손실 발생

---

### 2️⃣ **왜 +451% 상승한 코인이 백테스트에서 부적합일까?**

#### 가능한 원인들

**원인 A: 진입 조건 충족 실패**

우리 전략의 진입 조건 (Signal Engine):
```python
# backend/core/new_strategy/signal_engine.py

진입 점수 계산 (최대 170점):
- 거래량 급증 (30점)
- VWAP 돌파 (25점)
- 5m 상승 추세 (20점)
- EMA 정렬 (20점)
- 연속 상승 (15점)
- 3m 추세 확인 (20점)
- MACD 히스토그램 증가 (15점)
- MACD 골든크로스 (15점)
- RSI 반등 (10점)

진입 임계치:
- min_entry_score: 100점
- strong_entry_score: 130점
- instant_entry_score: 160점
```

**TNSRUSDT의 문제**:
```
24시간 +451% 상승 = 매우 급등 상태

→ 이미 과매수 구간 (RSI > 70)
→ 진입 조건 불충족 (과열 상태)
→ 백테스트 7일 동안 진입 기회 0회
→ 거래 횟수 0회
→ 점수 0점
```

---

**원인 B: 진입 타이밍 불일치**

```
실제 상승: 24시간 전부터 시작
백테스트 기간: 최근 7일

타임라인:
├─ 7일 전 (백테스트 시작) ─────────┐
│                                    │
│  (상승이 이미 시작되었을 가능성)    │
│                                    │
│  → 우리 전략의 진입 조건 불충족     │
│     (이미 과매수, EMA 정렬 완료)   │
│                                    │
├─ 1일 전 (급등 시작) ───────────────┤
│                                    │
│  +451% 상승 발생                   │
│                                    │
│  → 진입 조건 충족했을 가능성        │
│     (하지만 너무 늦음)             │
│                                    │
└─ 현재 (백테스트 종료) ─────────────┘

결과: 진입 기회 놓침 또는 손절 발생
```

---

**원인 C: 전략 설계 문제 (핵심!)**

우리 전략은 **"급등 초반 진입"**을 목표로 함:
```python
# 진입 조건
- EMA 정렬 (5>10>20>60>120)  ← 상승 초기에만 성립
- MACD 골든크로스             ← 상승 시작 시그널
- RSI 반등 (35 미만에서)      ← 과매도 구간

→ 이미 급등한 코인은 조건 불충족!
```

**+451% 상승한 코인의 현재 상태**:
```
EMA 정렬: ✅ (하지만 이미 과열)
MACD: ✅ (하지만 골든크로스는 과거)
RSI: ❌ 과매수 (70~90) - 진입 조건 불충족
거래량: ❌ 이미 급등 후 - 스파이크 지속 불가

→ 우리 전략으로는 진입 불가!
```

---

### 3️⃣ **실거래 vs 백테스트 비교**

| 항목 | 실시간 랭킹리스트 | 백테스트 적합성 |
|------|-----------------|----------------|
| **평가 기준** | 24시간 상승률 | 7일 전략 수익률 |
| **목적** | 상승 코인 발견 | 전략 적합성 검증 |
| **진입 여부** | 사용자 판단 | 전략 로직 자동 판단 |
| **TNSRUSDT 결과** | ✅ 1위 (+451%) | ❌ 부적합 (0점) |

---

## ⚠️ 사용자 우려사항 검증

### 질문 1: "실거래에서도 진입하지 않을 수 있나?"

**답변**: **예, 그렇습니다!**

**이유**:
```python
# backend/core/new_strategy/orchestrator.py

실거래 진입 조건 (step 메서드):
1. Signal Engine 점수 >= 130점 (strong_entry_score)
2. 15m 타임프레임 하락 추세 아님
3. Risk Manager 승인
4. 포지션 미보유

→ TNSRUSDT가 +451% 상승했어도
   현재 시점에서 진입 조건 불충족 시 진입 안 함!
```

**실제 시나리오**:
```
1. 사용자가 TNSRUSDT를 Alpha 엔진에 배치
2. [거래 활성화] 클릭
3. Orchestrator.step() 실행
4. Signal Engine 평가:
   - RSI: 85 (과매수)
   - 점수: 60점 (진입 임계치 130점 미달)
5. 결과: HOLD (진입 안 함)

→ 엔진은 실행 중이지만 거래 안 함!
```

---

### 질문 2: "전략이 잘못된 것 아닌가?"

**답변**: **전략 설계와 사용 목적의 불일치**

#### 전략 설계 의도

```
우리 전략 = "급등 초반 포착 전략"

목표:
- 상승 초기 진입 (RSI 30~50)
- 추세 확인 후 진입 (EMA 정렬 시작)
- 리스크 관리 (MDD < 5%)

→ 안전한 진입, 안정적인 수익
```

#### 현재 사용 방식

```
사용자 기대 = "24시간 급등 코인 자동 매매"

현재:
- 이미 급등한 코인 선택 (TNSRUSDT +451%)
- 엔진 배치 → 진입 기대

문제:
- 전략은 "급등 초반"을 찾도록 설계됨
- 이미 급등한 코인은 "과열" 상태로 판단
- 진입 조건 불충족 → 거래 안 함
```

---

## 🎯 핵심 문제 정리

### 근본 원인

**1. 백테스팅과 랭킹리스트의 평가 기준 불일치**

```
랭킹리스트: 24시간 상승률 (과거 성과)
백테스트: 7일 전략 수익률 (전략 적합성)

→ 서로 다른 것을 측정하므로 불일치 정상!
```

**2. 전략 설계와 사용 목적의 괴리**

```
전략 목적: 급등 초반 포착 (안전 진입)
사용자 목적: 급등 중인 코인 매매 (추격 진입)

→ 설계 의도와 다른 사용법!
```

**3. 백테스팅의 한계**

```
백테스트 기간: 7일 또는 30일
실제 상승: 24시간

→ 백테스트 기간 내 진입 조건 불충족
→ 거래 기회 없음
→ 점수 0점 (부적합)

BUT!
실제로는 24시간 전에 진입했다면 +451% 수익 가능
→ 백테스트가 실제 수익성을 반영 못 함!
```

---

## ✅ 정상 동작 여부

### 백테스팅 로직: ✅ **정상 동작**

```python
# 백테스트는 다음을 정확히 측정:

1. 우리 전략으로 7일간 거래했을 때 수익률
2. 진입 조건 충족 여부
3. 리스크 관리 성능

→ TNSRUSDT는 7일간 우리 전략으로 수익 못 냄
→ "부적합" 판정 정확함!
```

### 실거래 로직: ✅ **정상 동작**

```python
# 실거래 엔진은 다음을 정확히 실행:

1. Signal Engine 점수 >= 130점일 때만 진입
2. 과열 상태 (RSI > 70) 시 진입 안 함
3. Risk Manager 승인 필요

→ 과열된 코인은 진입 안 함
→ 안전 장치 작동 정확함!
```

---

## 🚧 문제점 요약

### 문제 1: **백테스팅의 오해의 소지**

```
문제:
- 사용자는 "+451% 상승" = "적합" 기대
- 백테스트는 "7일 전략 수익" = "부적합" 판정

→ 사용자 혼란 발생!
```

**원인**:
- 백테스트가 "과거 급등"이 아닌 "전략 적합성"을 측정
- 설명 부족

---

### 문제 2: **전략과 사용법의 불일치**

```
문제:
- 전략: 급등 초반 포착 (RSI 30~50)
- 사용자: 이미 급등한 코인 매매 (RSI 70~90)

→ 진입 조건 불충족!
```

**원인**:
- 전략 설계 의도 설명 부족
- 사용자 가이드 없음

---

### 문제 3: **백테스트 기간 설정 문제**

```
문제:
- 백테스트 7일 vs 실제 급등 24시간
- 타이밍 불일치로 진입 기회 놓침

→ 백테스트가 실제 수익성 반영 못 함!
```

**원인**:
- 고정된 백테스트 기간 (7일/30일)
- 급등 시점 고려 안 함

---

## 📊 검증 결과

### 1. 백테스팅 로직 검증

**코드 위치**: `backend/api/routes.py` (line 515-600)

**검증 항목**:
```python
✅ 승률 평가: 정상 (win_rate 기반)
✅ 수익률 평가: 정상 (total_pnl_pct 기반)
✅ MDD 평가: 정상 (max_drawdown 기반)
✅ 거래 횟수 평가: 정상 (total_trades 기반)
✅ 점수 계산: 정상 (0~100점)
✅ 적합성 판단: 정상 (70점 기준)
```

**결론**: 백테스팅 로직은 **정상 동작**

---

### 2. 실거래 진입 조건 검증

**코드 위치**: `backend/core/new_strategy/signal_engine.py` (line 85-105)

**검증 항목**:
```python
✅ 진입 임계치: 130점 (strong_entry_score)
✅ 점수 계산: 최대 170점 (9개 조건)
✅ 과열 필터: 15m 하락 추세 시 진입 억제
✅ RSI 조건: 35 미만에서 반등만 가점

→ TNSRUSDT (RSI 85) = 진입 조건 불충족
→ 점수 60점 (130점 미달)
→ HOLD (진입 안 함)
```

**결론**: 실거래 진입 조건은 **정상 동작**

---

### 3. 백테스트 실행 로직 검증

**코드 위치**: `backend/core/new_strategy/backtest_adapter.py` (line 200-350)

**검증 항목**:
```python
✅ 데이터 로드: 7일/30일 과거 데이터
✅ Orchestrator.step() 호출: 정상
✅ 진입/청산 로직: 정상
✅ 메트릭 계산: 정상

BUT!
⚠️ 문제 발견:
- _inject_data_to_orchestrator() 메서드가 비어 있음!
  (line 304-312: pass만 있음)

→ Orchestrator가 백테스트 데이터를 받지 못함!
→ 실제 백테스트가 제대로 동작 안 할 가능성!
```

**결론**: 백테스트 실행 로직에 **구현 누락** 발견!

---

## 🚨 치명적 버그 발견!

### 백테스트 데이터 주입 미구현

**파일**: `backend/core/new_strategy/backtest_adapter.py` (line 304-312)

```python
def _inject_data_to_orchestrator(self, idx: int):
    """
    Orchestrator의 DataFetcher 캐시에 백테스트 데이터 주입
    (실제 구현 시 MarketDataCache를 백테스트 모드로 전환)
    """
    # TODO: 실제 구현 필요
    # orchestrator.data_fetcher.cache.update({
    #     "1m": self.klines_1m.iloc[:idx+1],
    #     "3m": self.klines_3m.iloc[:self.current_3m_idx+1],
    #     "15m": self.klines_15m.iloc[:self.current_15m_idx+1],
    # })
    pass  # ← 아무것도 안 함!
```

**영향**:
```
Orchestrator.step() 실행 시:
1. DataFetcher가 빈 캐시 참조
2. 지표 계산 실패
3. 진입 조건 평가 실패
4. 항상 HOLD 반환

결과:
→ 백테스트에서 거래 기회 0회
→ 점수 0점
→ 모든 심볼 "부적합" 판정!
```

---

## 🎊 최종 결론

### 1. 사용자 우려사항 검증 결과

**질문**: "실거래에서도 진입하지 않을 수 있나?"

**답변**: **예, 맞습니다!**
- ✅ 이미 급등한 코인 (RSI > 70)은 진입 조건 불충족
- ✅ 전략은 "급등 초반" 포착 설계
- ✅ 안전 장치로 과열 코인 진입 억제

---

**질문**: "전략이 잘못된 것 아닌가?"

**답변**: **전략은 정상이지만, 두 가지 문제 있음**

**문제 A: 백테스트 구현 버그** (치명적!)
```
_inject_data_to_orchestrator() 미구현
→ 백테스트 실행 안 됨
→ 모든 심볼 "부적합" 판정

→ 수정 필요!
```

**문제 B: 전략-사용법 불일치** (설계 의도)
```
전략 설계: 급등 초반 포착 (안전 진입)
사용자 기대: 급등 중인 코인 매매 (추격 진입)

→ 사용자 가이드 필요!
```

---

### 2. 백테스팅 "부적합" 판정 원인

**원인 1**: ⚠️ **백테스트 데이터 주입 미구현** (버그!)
- Orchestrator가 백테스트 데이터를 받지 못함
- 진입 조건 평가 불가
- 거래 기회 0회 → 점수 0점

**원인 2**: ✅ **전략 설계 의도대로 동작** (정상)
- 이미 급등한 코인은 과열 상태
- 진입 조건 불충족 (RSI > 70)
- 안전 장치 작동

**원인 3**: ✅ **백테스트 기간 불일치** (정상)
- 7일 백테스트 vs 24시간 급등
- 타이밍 불일치로 진입 기회 없음

---

### 3. 해결 방안 (수정 금지 - 보고만)

#### 해결 A: 백테스트 구현 완성 (필수!)
```python
# _inject_data_to_orchestrator() 구현 필요

def _inject_data_to_orchestrator(self, idx: int):
    # 1. 백테스트 데이터를 DataFetcher 캐시에 주입
    # 2. Orchestrator가 과거 데이터로 지표 계산
    # 3. 정확한 진입/청산 시그널 생성
```

#### 해결 B: 사용자 가이드 제공
```
1. 전략 설계 의도 설명
   - "급등 초반 포착" 전략
   - 과열 코인 진입 억제

2. 사용법 안내
   - 백테스트 "적합" 코인 우선 거래
   - 이미 급등한 코인은 조심

3. 백테스트 의미 설명
   - "과거 급등" ≠ "전략 적합성"
   - 7일 전략 수익률 측정
```

#### 해결 C: 백테스트 기간 최적화
```
현재: 고정 7일/30일
개선: 급등 시작 시점 탐지 + 동적 기간 설정
```

---

## 📋 요약

| 항목 | 결과 | 비고 |
|------|------|------|
| **백테스팅 로직** | ✅ 정상 | 평가 기준 정확함 |
| **실거래 로직** | ✅ 정상 | 진입 조건 정확함 |
| **백테스트 실행** | ❌ **버그** | 데이터 주입 미구현 |
| **전략 설계** | ✅ 정상 | 의도대로 동작 |
| **사용자 우려** | ✅ **타당** | 실거래에서 진입 안 할 수 있음 |

---

**백테스팅 "부적합" 판정은 버그(데이터 주입 미구현) + 전략 설계 의도(급등 초반 포착)의 조합입니다!**

**수정이 필요한 부분은 `_inject_data_to_orchestrator()` 메서드입니다!** ✅
