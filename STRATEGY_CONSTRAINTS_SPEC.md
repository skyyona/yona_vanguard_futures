# YONA Vanguard Futures 전략 상위 제약 확정 문서

**작성일:** 2025-11-18  
**목적:** Option B(신규 모듈형 고도화) 아키텍처 설계 기준점  
**상태:** FROZEN (확정 완료 - 아키텍처 설계 진행 시 변경 금지)

---

## 1. 전략 범위 및 기본 원칙

### 1.1 거래 방향 및 주문 유형
- **거래 방향:** Long Position(롱 포지션) 전용
- **주문 유형:** Market Order(시장가) 전용
- **포지션 제한:** 심볼당 단일 포지션(Multiple positions per symbol 금지)
- **시장:** Binance USDT-M Futures 전용

### 1.2 전략 스타일
- **주요 스타일:** 초단기(Scalping) 및 단기(Day Trading) 중심
- **목표 보유 시간:** 수분 ~ 수십분 (장기 보유 지양)
- **거래 빈도:** 높음 (단, 리스크 관리 조건 충족 시에만)

---

## 2. 리스크 관리 최우선 원칙 (CRITICAL)

### 2.1 엄격한 손절매 정책
- **기본 손절:** 0.5% 필수 적용 (모든 포지션)
- **동적 손절 이동 (Trailing to Break-Even):**
  - 수익 1% 도달 시 → 손절가를 **본절(Break-Even)** 또는 **진입가 + 0.2%** 지점으로 이동
  - 이후 추가 상승 시 트레일링 스톱 적용 (상위 제약에서는 0.3~0.7% 범위 권장)
- **손절 우선순위:** 손절 조건이 익절보다 먼저 평가되어야 함

### 2.2 시장 상황 기반 거래 제한
- **진입 금지 조건:**
  - 횡보장(Sideways/Neutral Trend)
  - 하락 추세(Downtrend)
- **진입 허용 조건:**
  - **강한 상승 추세(Strong Uptrend)에서만 롱 포지션 진입**
  - 15분봉 확인: EMA 정배열, MACD 상승, 충분한 거래량 동반 필수

### 2.3 레버리지 정책
- **목표 레버리지:** 50배 활용 (수익 극대화)
- **제약 조건:**
  - 반드시 엄격한 리스크 관리 원칙(손절 0.5%) 내에서만 운영
  - 프로파일별 최대 레버리지 상한 설정 (안전장치)
  - 레버리지 자동 상향 조정 금지 (사용자 명시 설정 시에만)

### 2.4 복리 재투자 시스템
- **목표:** 최대 수익 목표 및 월 1억 원 수익 가능성
- **자동화 요구사항:**
  - 실현 손익을 매달 총 운용 자본에 자동 재투자
  - 손실 누적 시 최소 배분 자금 하한 적용 (자금 고갈 방지)

---

## 3. 필수 지표 및 다중 타임프레임 분석

### 3.1 핵심 지표 조합 (필수)
모든 진입/청산 조건은 아래 지표 조합을 **필수적으로 포함**해야 함:

1. **EMA (Exponential Moving Average):**
   - **단기:** EMA 5, EMA 10, EMA 20
   - **중기:** EMA 60
   - **장기:** EMA 120
   - **정배열 확인:** EMA5 > EMA10 > EMA20 (1분봉/3분봉)
   - **지지선 반등:** 5분봉 EMA 지지선에서의 반등 신호 활용

2. **Stochastic RSI:**
   - **1분봉 & 3분봉:** 포지션 진입 신호 (과매도 후 상승 전환 20~35 구간)
   - **15분봉:** 주요 사이클 변화 및 추세의 힘 측정
   - **과매수 경고:** 75 이상 시 진입 금지 또는 감점

3. **MACD (Moving Average Convergence Divergence):**
   - **골든 크로스:** MACD Line > Signal Line (5분봉 필수)
   - **히스토그램:** 양수 전환 확인
   - **15분봉:** 상승 추세 지속 여부 확인

4. **VWAP (Volume Weighted Average Price):**
   - **돌파 신호:** 현재가 > VWAP (실제 계산 필수, EMA 근사 금지)
   - **신뢰도 강화:** 거래량 동반 여부 교차 검증

5. **ATR (Average True Range) - 추가:**
   - **변동성 측정:** 진입 전 시장 변동성 확인
   - **동적 손절:** ATR 기반 손절/익절 거리 조정 (선택 사항)
   - **변동성 급증 대응:** ATR 급증 시 포지션 축소 또는 진입 보류

6. **Volume Spike (거래량 급증):**
   - **정의:** 최근 20개 캔들 평균 대비 3배 이상 거래량
   - **중요성:** 강한 상승 돌파 시 Volume Spike 동반 필수
   - **가중치:** 진입 점수 시스템에서 높은 가중치 부여 (25~30점)

### 3.2 다중 타임프레임 분석 전략 (의무)

#### 역방향 분석 프로세스 (Top-Down)
1. **15분봉 (큰 그림 파악):**
   - EMA 정배열 확인 (EMA20 > EMA60 > EMA120)
   - MACD 상승 확인 (골든 크로스 + 히스토그램 양수)
   - 충분한 거래량 확인 (Volume Spike 또는 평균 이상)
   - 15분봉 Stoch RSI: 사이클 전환 및 추세 강도 측정

2. **5분봉 (세밀한 진입점 탐색):**
   - 15분봉 상승 추세 확인 후 전환
   - EMA 지지선 반등 확인 (EMA5, EMA10, EMA20)
   - 5분봉 MACD 골든 크로스 포착
   - 5분봉 Stoch RSI 과매도(20~35) 후 상승 전환

3. **1분봉 & 3분봉 (즉시 진입 신호):**
   - 3분봉 추세 확인 (EMA 정배열 유지)
   - 1분봉 Stoch RSI 과매도 반등 (진입 타이밍)
   - 거래량 동반 확인 (Volume Spike)

#### 타임프레임별 역할
- **15분봉:** 전반적인 상승 추세 확인 (필터링)
- **5분봉:** 진입 준비 구간 식별 (Setup)
- **1분봉/3분봉:** 정확한 진입 타이밍 결정 (Trigger)

---

## 4. 진입 조건 (Entry Conditions)

### 4.1 필수 조건 (AND 로직)
모든 조건을 **동시에 충족**해야 진입 가능:

1. **추세 확인 (15분봉):**
   - EMA 정배열 (EMA20 > EMA60 > EMA120)
   - MACD > Signal (골든 크로스)
   - 충분한 거래량 (평균 이상 또는 Volume Spike)

2. **진입 신호 (5분봉):**
   - EMA 지지선 반등 (가격이 EMA5, EMA10, EMA20 중 하나 이상에서 지지)
   - MACD 골든 크로스 발생
   - Stoch RSI 과매도(20~35) 후 상승 전환

3. **확인 신호 (1분봉/3분봉):**
   - Stoch RSI 과매도 반등 (20~35 구간)
   - Volume Spike 동반 (최근 20개 평균 대비 3배 이상)
   - 현재가 > VWAP

### 4.2 진입 금지 조건 (Exclusion)
하나라도 해당되면 진입 **절대 금지**:

1. 15분봉 하락 추세 또는 횡보 (EMA20 < EMA60)
2. Stoch RSI 과매수 (75 이상) - 1분봉/3분봉/5분봉 모두
3. MACD 데드 크로스 (MACD < Signal)
4. 거래량 부족 (평균 이하 지속)
5. ATR 급증 (변동성 과열) - 선택 사항

### 4.3 점수 시스템 (선택 사항)
점수 기반 진입 판단 (170점 만점):

| 신호 | 가중치 | 조건 |
|------|--------|------|
| Volume Spike | 25~30점 | 최근 20개 평균 대비 3배 이상 |
| VWAP 돌파 | 20점 | 현재가 > VWAP |
| EMA 정배열 (15분) | 20점 | EMA20 > EMA60 > EMA120 (0.1% 버퍼) |
| MACD 골든 크로스 | 15점 | MACD > Signal, Histogram > 0 |
| Stoch RSI 반등 (1분/3분) | 10점 | 20 < Stoch < 35 |
| 5분봉 EMA 지지 반등 | 15점 | 가격이 EMA5/10/20 근처 반등 |
| 15분봉 추세 강도 | 10점 | MACD Histogram 증가 추세 |
| ATR 안정 | 10점 | ATR 평균 이하 (변동성 낮음) |
| **감점:** Stoch 과매수 | -10점 | Stoch > 75 |
| **감점:** MACD 다이버전스 | -15점 | 가격 상승 vs MACD 하락 |

**진입 임계:**
- **160점 이상 (94%):** 즉시 진입
- **130~159점 (76~93%):** 진입 권장 (모니터 상태)
- **100~129점 (59~76%):** 대기 (GUI 표시만)
- **100점 미만:** 진입 금지

---

## 5. 청산 조건 (Exit Conditions)

### 5.1 손절 (Stop Loss) - 최우선
1. **기본 손절:** 진입가 대비 -0.5% 도달 시 즉시 청산
2. **동적 손절 (1% 수익 도달 후):**
   - 손절가를 본절(Break-Even) 또는 진입가 + 0.2%로 이동
   - 이후 최고가 갱신 시 트레일링 적용

### 5.2 익절 (Take Profit)
- **목표 수익률 (프로파일별 차등):**
  - Alpha (1분): 3.0~4.0%
  - Beta (5분): 4.5~5.5%
  - Gamma (15분 or 1h): 8.0~9.0%
- **부분 익절 (선택):** 목표의 50% 도달 시 절반 청산 후 나머지 트레일링

### 5.3 트레일링 스톱 (Trailing Stop)
- **트리거:** 수익 1% 도달 후 활성화
- **트레일링 거리:** 최고가 대비 0.3~0.7% 하락 시 청산
- **ATR 기반 (선택):** 변동성 높을 때 트레일링 거리 확대

### 5.4 추세 반전 청산
- **EMA 역전:** EMA20 < EMA60 (0.1% 버퍼)
- **MACD 데드 크로스:** MACD < Signal
- **Stoch RSI 과매수:** Stoch > 80 지속 (과열 신호)

### 5.5 시간 제한 청산 (선택)
- **최대 보유 시간 초과 시 강제 청산:**
  - Alpha: 30분
  - Beta: 1시간
  - Gamma: 4시간

---

## 6. 자산 분배 및 다중 엔진 관리

### 6.1 포트폴리오 구조
- **엔진 수:** 3개 (Alpha, Beta, Gamma)
- **심볼 할당:** 각 엔진당 1개 심볼 (동시 거래 가능)
- **자금 배분:**
  - 사용자 총 자금을 3개 엔진에 분산 (예: 각 33.3%)
  - 엔진별 독립적인 리스크 관리 (cross-margin 금지)

### 6.2 엔진별 프로파일 (초안)
| 엔진 | 타임프레임 | 목표 익절 | 손절 | 트레일링 | 스타일 |
|------|-----------|----------|------|---------|--------|
| Alpha | 1분/3분 | 3.0~4.0% | 0.5% | 0.3~0.5% | 초단기 스캘핑 |
| Beta | 1분/3분 | 3.0~4.0% | 0.5% | 0.3~0.5% | 초단기 스캘핑 |
| Gamma | 1분/3분 | 3.0~4.0% | 0.5% | 0.3~0.5% | 초단기 스캘핑 |

**Note:** 모든 엔진이 1분봉 및 3분봉 분석을 통한 진입 신호를 사용하여 초단기 스캘핑 전략을 공유합니다.

---

## 7. 시스템 안정성 및 데이터 요구사항

### 7.1 실시간 데이터 필수 요구사항
- **Binance WebSocket:** 실시간 캔들 스틱, Mark Price, 거래량
- **Binance REST API:** 계좌 정보, 포지션 조회, 주문 실행
- **데이터 신뢰성:**
  - 캔들 데이터 누락 시 이전 캔들 재사용 금지 (해당 tick 스킵)
  - Timestamp 지연 > 5초 시 경고 및 진입 보류

### 7.2 API 안정성 및 재시도 정책
- **재시도 정책:**
  - 네트워크 타임아웃: 지수 백오프 (1s, 2s, 4s), 최대 3회
  - -1021 (타임스탬프 오류): 서버 시간 재동기화 후 1회 재시도
  - -2019/-2021 (마진 관련): 경고 후 전략 비활성화
- **Rate Limit:** 바이낸스 제한 준수 (분당 1200 요청, 초당 10 주문)

### 7.3 지표 계산 안정성
- **캐시 정책:** 계산된 지표는 최대 2000개 캔들까지 캐시 (메모리 관리)
- **계산 실패:** 연속 5회 실패 시 해당 심볼 비활성화 + 알림
- **정확성 검증:** EMA/MACD/RSI 등은 표준 공식 준수 (근사치 금지)

---

## 8. 포지션 사이징 (위험 기반)

### 8.1 수량 계산 공식
**기존 방식 (폐기 예정):**
```
quantity = (배분 자금 × 레버리지) / 현재가
```

**신규 방식 (위험 기반 - 필수):**
```
허용 위험 금액 = 배분 자금 × risk_fraction (예: 0.5~1.0%)
예상 손실 금액 = 진입가 × stop_loss_percent × quantity
quantity = 허용 위험 금액 / (진입가 × stop_loss_percent)
```

**레버리지 적용:**
```
notional = 진입가 × quantity
if (notional / 배분자금) > max_leverage_effect:
    quantity 축소
```

### 8.2 거래 필터 검증 (사전 적용)
- **LOT_SIZE:** stepSize, minQty, maxQty
- **MIN_NOTIONAL:** 최소 명목 금액 (예: 5 USDT)
- **MARKET_LOT_SIZE:** 시장가 주문용 수량 제한
- **라운딩:** stepSize에 맞춰 내림 처리

### 8.3 슬리피지 및 수수료 고려
- **슬리피지 허용 한도:** 예상가 대비 ±0.1% (초과 시 경고)
- **수수료:** Maker 0.02%, Taker 0.04% (손익 계산 시 반영)

---

## 9. KPI 및 성공 지표

### 9.1 성능 목표
- **월 수익률:** 최대 수익 목표 (복리 재투자 포함)
- **월 수익 금액:** 1억 원 가능성 (자본 규모에 따름)
- **승률:** 60% 이상
- **Sharpe Ratio:** 1.5 이상 (백테스트 기준)

### 9.2 리스크 제한
- **최대 일일 손실:** 총 자본의 -2%
- **최대 연속 손실:** 3회 (4회째 도달 시 당일 거래 중단)
- **최대 드로우다운 (MDD):** -3% (초과 시 레버리지 축소 또는 거래 중단)

### 9.3 시스템 안정성 SLA
- **주문 실패율:** < 1%
- **지표 계산 실패율:** < 0.1%
- **평균 API 레이턴시:** < 500ms
- **95% API 레이턴시:** < 2초

---

## 10. Legacy 전략 격리 및 폐기 계획

### 10.1 격리 전략
- **폴더 이동:** `backend/core/strategies/legacy/`
  - `alpha_strategy.py` → `legacy/alpha_strategy.py`
  - `beta_strategy.py` → `legacy/beta_strategy.py`
  - `gamma_strategy.py` → `legacy/gamma_strategy.py`
  - `base_strategy.py` → `legacy/base_strategy.py`

### 10.2 Feature Flag
- **환경 변수:** `USE_LEGACY_STRATEGIES=false` (기본값)
- **설정 네임스페이스:** 
  - Legacy: `legacy_engine_settings`
  - New: `engine_profiles`

### 10.3 핵심 파일 공유 금지
**공유 금지 대상 (Legacy ↔ New 간):**
- `BinanceClient` 인스턴스 (별도 생성)
- 전역 싱글톤 (Config, Logger 분리 채널)
- DB 테이블 (별도 스키마 또는 접두어)

**공유 가능 (읽기 전용):**
- Rate Limit Manager (공용 제한 준수)
- Exchange Info Cache (심볼 필터 정보)

### 10.4 안전 폐기 체크리스트
- [ ] 신규 엔진 2시간 이상 안정 운영 (실거래 또는 샌드박스)
- [ ] 지표 값 비교 (Legacy vs New) ± 0.1% 이내
- [ ] 주문 체결 성공률 ≥ Legacy
- [ ] 손절/익절 트리거 타이밍 정확성 검증
- [ ] 복원(재시작) 후 상태 일치 (포지션/PNL)
- [ ] 레버리지/마진 변경 안전성 확인
- [ ] 메모리 사용 증가폭 < 30%
- [ ] 사용자 승인 (최종 확인)

**폐기 절차:**
1. Feature flag `USE_LEGACY_STRATEGIES=false` 활성화 (1주일 모니터링)
2. Legacy 호출 경로 제거 (import, 라우터 등)
3. `legacy/` 폴더 삭제 (Git 커밋 단위)
4. 문서 업데이트 (`CHANGELOG.md`, `MIGRATION.md`)

---

## 11. 확장 포인트 (향후 고려 사항)

### 11.1 Short Position 지원
- **조건:** Long 전략 안정화 후 추가
- **신호:** 하락 추세 확인 (EMA 역배열, MACD 데드 크로스 등)
- **리스크:** Short는 무한 손실 가능 → 더 엄격한 손절 필요

### 11.2 부분 청산 (Scale Out)
- **트리거:** 목표 수익의 50% 도달 시
- **청산 비율:** 포지션의 50% 청산, 나머지 트레일링
- **복잡도:** 부분 수량 관리 + 평균 손익 계산

### 11.3 동적 Risk Fraction
- **변동성 기반:** ATR 높을 때 risk_fraction 감소 (0.5% → 0.3%)
- **손실 기반:** 연속 손실 시 자동 축소 (0.5% → 0.25%)
- **복구 조건:** 승률 회복 시 원래 수준 복원

### 11.4 멀티 계좌 / 멀티 심볼
- **멀티 계좌:** ExecutionAdapter 인스턴스 다중 관리
- **멀티 심볼:** 각 엔진이 복수 심볼 동시 모니터링 (우선순위 점수 기반)

---

## 12. 검증 완료 사항

### 12.1 사용자 요구사항 반영 여부
- [x] Long Position 전용, 시장가 주문
- [x] 0.5% 손절 + 1% 수익 시 본절 이동
- [x] 강한 상승 추세에서만 진입
- [x] EMA, Stoch RSI, MACD, VWAP, ATR, Volume Spike 지표 필수
- [x] 다중 타임프레임 (15분 → 5분 → 1분/3분) 역방향 분석
- [x] 50배 레버리지 활용 (리스크 관리 내)
- [x] 복리 재투자 시스템 (최대 수익 목표)
- [x] 3개 엔진 자산 분배 (Alpha, Beta, Gamma) - 모두 1분/3분봉 진입
- [x] Binance API 안정성 (WebSocket, REST, 재시도)

### 12.2 누락 항목 최종 확인
- [x] 위험 기반 포지션 사이징 공식
- [x] 거래 필터 검증 (stepSize, minNotional)
- [x] 슬리피지 및 수수료 고려
- [x] Legacy 격리 및 폐기 체크리스트
- [x] KPI 및 성공 지표 정의
- [x] 시스템 안정성 SLA
- [x] 확장 포인트 (Short, 부분청산, 동적 리스크)

---

## 13. 다음 단계 (아키텍처 설계 단계)

### 13.1 즉시 진행 가능 항목
1. **모듈 인터페이스 설계:**
   - DataFetcher, IndicatorEngine, SignalEngine, RiskManager, ExecutionAdapter 상세 시그니처
2. **백테스트 하니스 계약:**
   - 입력 (과거 캔들), 출력 (성능 리포트), 평가 지표
3. **StrategyProfile 스키마:**
   - Alpha/Beta/Gamma 프로파일 JSON 구조 정의

### 13.2 대기 중 항목 (구현 후 결정)
- Gamma 타임프레임 (15분 vs 1시간) 최종 선택
- 점수 시스템 vs Rule 기반 조건 선택
- 트레일링 방식 (고점 기반 vs ATR 기반) 최종 선택
- 부분 청산 적용 여부

---

## 14. 승인 상태

**문서 상태:** ✅ FROZEN (확정 완료)  
**승인자:** 사용자  
**승인일:** 2025-11-18  
**다음 작업:** 모듈 인터페이스 설계 및 백테스트 하니스 계약 작성

---

**변경 이력:**
- 2025-11-18: 초안 작성 및 확정 (사용자 요구사항 기반)
